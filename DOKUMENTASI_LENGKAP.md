# Dokumentasi Lengkap - Hauler Truck Mining Operations

## ğŸ“‹ Daftar Isi

1. [Gambaran Umum](#gambaran-umum)
2. [Arsitektur Sistem](#arsitektur-sistem)
3. [State Machine & Flowchart](#state-machine--flowchart)
4. [Alur Data (Data Flow)](#alur-data-data-flow)
5. [Proses Data: Sensor hingga Server](#proses-data-sensor-hingga-server)
6. [Metode Sinkronisasi](#metode-sinkronisasi)
7. [Olah Data & Event Sourcing](#olah-data--event-sourcing)
8. [Struktur Data Firestore](#struktur-data-firestore)
9. [Proses Bisnis Detail](#proses-bisnis-detail)

---

## Gambaran Umum

**Hauler Truck** adalah aplikasi Flutter untuk mengelola operasi tambang dengan sistem **offline-first** dan **event-sourcing**. Aplikasi ini mensimulasikan siklus operasional truk hauler dari antrian di loader hingga pembongkaran di dump point.

### Fitur Utama

- âœ… **Offline-First**: Operasi tetap berjalan meski tanpa koneksi internet
- âœ… **Event-Sourcing**: Semua perubahan status dicatat sebagai event
- âœ… **Auto Transitions**: Transisi status otomatis berdasarkan lokasi GPS dan sensor
- âœ… **Server-Arbiter**: Server sebagai single source of truth
- âœ… **Ping-Based Sync**: Strategi sinkronisasi berdasarkan kualitas koneksi
- âœ… **Real-time Tracking**: Pelacakan posisi real-time dengan peta

---

## Arsitektur Sistem

### Diagram Arsitektur

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         HAULER TRUCK SYSTEM                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT (Flutter App)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Presentation â”‚    â”‚   Domain      â”‚    â”‚    Data      â”‚        â”‚
â”‚  â”‚    Layer     â”‚â”€â”€â”€â–¶â”‚    Layer     â”‚â”€â”€â”€â–¶â”‚    Layer     â”‚        â”‚
â”‚  â”‚              â”‚    â”‚              â”‚    â”‚              â”‚        â”‚
â”‚  â”‚  - BLoC      â”‚    â”‚  - Entities  â”‚    â”‚  - Models    â”‚        â”‚
â”‚  â”‚  - Widgets   â”‚    â”‚  - Use Cases â”‚    â”‚  - Repos     â”‚        â”‚
â”‚  â”‚  - Pages     â”‚    â”‚  - Repos     â”‚    â”‚  - DataSourcesâ”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â”‚                   â”‚                   â”‚                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                            â”‚                                       â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚         â”‚                                      â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   Hive DB    â”‚                    â”‚  Firestore   â”‚            â”‚
â”‚  â”‚ (Offline     â”‚                    â”‚   (Online)   â”‚            â”‚
â”‚  â”‚   Queue)     â”‚                    â”‚              â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTPS / WebSocket
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SERVER (Cloud Functions)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Firebase Cloud Functions                       â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚  â€¢ processIntent()    - Validasi & apply transitions       â”‚   â”‚
â”‚  â”‚  â€¢ processTelemetry() - Process GPS & sensor data         â”‚   â”‚
â”‚  â”‚  â€¢ checkAutoTransitions() - Auto trigger transitions      â”‚   â”‚
â”‚  â”‚  â€¢ cleanupTelemetry() - Periodic cleanup                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚                                       â”‚
â”‚                            â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Cloud Firestore                         â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚  Collections:                                              â”‚   â”‚
â”‚  â”‚  â€¢ haulers          - Status hauler real-time              â”‚   â”‚
â”‚  â”‚  â€¢ hauler_events    - Event log (event-sourcing)          â”‚   â”‚
â”‚  â”‚  â€¢ telemetry        - GPS & sensor data                   â”‚   â”‚
â”‚  â”‚  â€¢ cycles           - Cycle tracking                      â”‚   â”‚
â”‚  â”‚  â€¢ loaders          - Loader equipment                    â”‚   â”‚
â”‚  â”‚  â€¢ intents          - Client requests                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Clean Architecture Layers

#### 1. **Presentation Layer**
- **BLoC**: State management (HaulerBloc, SimulationBloc)
- **Widgets**: UI components (Map, Status Panel, Event Log)
- **Pages**: Screen components

#### 2. **Domain Layer**
- **Entities**: Business objects (Hauler, Cycle, Event, etc.)
- **Use Cases**: Business logic (StartCycle, UpdateLocation, etc.)
- **Repositories**: Abstract interfaces

#### 3. **Data Layer**
- **Models**: Data transfer objects dengan serialization
- **Repositories**: Implementasi repository interfaces
- **Data Sources**: 
  - Remote: Firestore
  - Local: Hive (offline queue)

---

## State Machine & Flowchart

### State Machine Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HAULER STATE MACHINE                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ STANDBY  â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          â”‚                                                  â”‚
    â”‚ Menunggu â”‚                                                  â”‚
    â”‚ Penugasanâ”‚                                                  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                  â”‚
         â”‚                                                        â”‚
         â”‚ Start Cycle                                            â”‚
         â”‚                                                        â”‚
         â–¼                                                        â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                 â”‚
    â”‚ QUEUING  â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚          â”‚                                                 â”‚
    â”‚ Mengantriâ”‚                                                 â”‚
    â”‚ di Loaderâ”‚                                                 â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                 â”‚
         â”‚                                                       â”‚
         â”‚ T1: In loader radius                                 â”‚
         â”‚     + loader.waitingTruck = true                     â”‚
         â”‚     + GPS accuracy â‰¤ 50m                            â”‚
         â”‚                                                       â”‚
         â–¼                                                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                 â”‚
    â”‚ SPOTTING â”‚                                                 â”‚
    â”‚          â”‚                                                 â”‚
    â”‚Positioningâ”‚                                                â”‚
    â”‚ di Loader â”‚                                                â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                 â”‚
         â”‚                                                       â”‚
         â”‚ Loader confirmed                                      â”‚
         â”‚                                                       â”‚
         â–¼                                                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                 â”‚
    â”‚ LOADING  â”‚                                                 â”‚
    â”‚          â”‚                                                 â”‚
    â”‚Proses    â”‚                                                 â”‚
    â”‚Pemuatan  â”‚                                                 â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                 â”‚
         â”‚                                                       â”‚
         â”‚ Loading complete                                      â”‚
         â”‚                                                       â”‚
         â–¼                                                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
    â”‚HAULING_LOAD â”‚                                             â”‚
    â”‚             â”‚                                             â”‚
    â”‚ Mengangkut  â”‚                                             â”‚
    â”‚   Muatan    â”‚                                             â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
         â”‚                                                       â”‚
         â”‚ T2: In dump radius                                   â”‚
         â”‚     + bodyUp = true                                  â”‚
         â”‚     + GPS accuracy â‰¤ 50m                            â”‚
         â”‚                                                       â”‚
         â–¼                                                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                 â”‚
    â”‚ DUMPING  â”‚                                                 â”‚
    â”‚          â”‚                                                 â”‚
    â”‚Proses    â”‚                                                 â”‚
    â”‚Pembongkaranâ”‚                                               â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                 â”‚
         â”‚                                                       â”‚
         â”‚ bodyUp = false                                        â”‚
         â”‚                                                       â”‚
         â–¼                                                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
    â”‚HAULING_EMPTY â”‚                                            â”‚
    â”‚              â”‚                                            â”‚
    â”‚ Kembali ke   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚   Loader     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Transition Guards

| From Status | To Status | Guard Condition | Trigger |
|------------|-----------|-----------------|---------|
| STANDBY | QUEUING | Cycle started | Manual |
| QUEUING | SPOTTING | In loader radius + loader waiting + GPS accurate | Auto (T1) |
| SPOTTING | LOADING | In loader radius | Auto/Manual |
| LOADING | HAULING_LOAD | Loading complete | Manual |
| HAULING_LOAD | DUMPING | In dump radius + bodyUp + GPS accurate | Auto (T2) |
| DUMPING | HAULING_EMPTY | bodyUp = false | Auto |
| HAULING_EMPTY | QUEUING | In loader radius | Auto |

### Flowchart Proses Transisi

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FLOWCHART PROSES TRANSISI STATUS                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

START
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Event Triggered â”‚ (Location update, Body toggle, Manual, etc.)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Get Current Status      â”‚
â”‚ & Context               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check State Machine     â”‚
â”‚ Allowed Transition?    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€ NO â”€â”€â–¶ [REJECT] â”€â”€â–¶ END
         â”‚
         â–¼ YES
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Build TransitionContext â”‚
â”‚ - Location              â”‚
â”‚ - GPS Accuracy          â”‚
â”‚ - Loader State          â”‚
â”‚ - Body State            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check Guard Conditions  â”‚
â”‚ (TransitionGuards)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€ FAIL â”€â”€â–¶ [REJECT] â”€â”€â–¶ END
         â”‚
         â–¼ PASS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create HaulerEvent      â”‚
â”‚ - Generate dedupKey     â”‚
â”‚ - Increment seq         â”‚
â”‚ - Set deviceTime        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Update Local State      â”‚
â”‚ - Hauler status         â”‚
â”‚ - Cycle steps           â”‚
â”‚ - Event seq             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check Connectivity      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€ ONLINE â”€â”€â–¶ [Save to Firestore]
         â”‚                      â”‚
         â”‚                      â–¼
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚ Success?         â”‚
         â”‚              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                   â”‚
         â”‚                   â”œâ”€â”€â”€ YES â”€â”€â–¶ [Update UI] â”€â”€â–¶ END
         â”‚                   â”‚
         â”‚                   â–¼ NO
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚ Queue for Retry  â”‚
         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ OFFLINE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Queue to Offline Queue  â”‚
â”‚ (Hive)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Update UI Optimisticallyâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
END
```

---

## Alur Data (Data Flow)

### Diagram Alur Data Lengkap

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        DATA FLOW DIAGRAM                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT SIDE                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   GPS        â”‚         â”‚   Sensor     â”‚         â”‚   User      â”‚â”‚
â”‚  â”‚  Location    â”‚         â”‚   Body Up    â”‚         â”‚   Action    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚         â”‚                        â”‚                        â”‚        â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                      â”‚                       â”‚                     â”‚
â”‚                      â–¼                       â–¼                     â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚              â”‚ Location     â”‚         â”‚ Body State   â”‚            â”‚
â”‚              â”‚ Repository   â”‚         â”‚ Update       â”‚            â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                     â”‚                        â”‚                     â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                  â”‚                                 â”‚
â”‚                                  â–¼                                 â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                          â”‚  HaulerBloc  â”‚                         â”‚
â”‚                          â”‚              â”‚                         â”‚
â”‚                          â”‚ - Process    â”‚                         â”‚
â”‚                          â”‚   Auto      â”‚                         â”‚
â”‚                          â”‚   Transitionsâ”‚                         â”‚
â”‚                          â”‚ - Update     â”‚                         â”‚
â”‚                          â”‚   State      â”‚                         â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                 â”‚                                 â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                    â”‚                         â”‚                    â”‚
â”‚                    â–¼                         â–¼                    â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚          â”‚ Create Event â”‚         â”‚ Create       â”‚              â”‚
â”‚          â”‚              â”‚         â”‚ Telemetry    â”‚              â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                 â”‚                        â”‚                      â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚                    â”‚ Hauler       â”‚                            â”‚
â”‚                    â”‚ Repository   â”‚                            â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                           â”‚                                    â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚              â”‚                         â”‚                       â”‚
â”‚              â–¼                         â–¼                       â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚    â”‚ Firestore    â”‚         â”‚ Offline      â”‚                 â”‚
â”‚    â”‚ Data Source  â”‚         â”‚ Queue        â”‚                 â”‚
â”‚    â”‚              â”‚         â”‚ (Hive)       â”‚                 â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚           â”‚                        â”‚                          â”‚
â”‚           â”‚                        â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                        â”‚
            â”‚ HTTPS                  â”‚ Local Storage
            â”‚                        â”‚
            â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SERVER SIDE                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Cloud Firestore                                â”‚   â”‚
â”‚  â”‚                                                             â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚  haulers     â”‚  â”‚hauler_events â”‚  â”‚  telemetry   â”‚    â”‚   â”‚
â”‚  â”‚  â”‚  collection  â”‚  â”‚  collection  â”‚  â”‚  collection  â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚         â”‚                  â”‚                  â”‚            â”‚   â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚  â”‚                            â”‚                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                â”‚                                  â”‚
â”‚                                â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         Cloud Functions Triggers                            â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚ â”‚
â”‚  â”‚  â”‚ processTelemetry â”‚      â”‚  processIntent   â”‚           â”‚ â”‚
â”‚  â”‚  â”‚                  â”‚      â”‚                  â”‚           â”‚ â”‚
â”‚  â”‚  â”‚ - Update hauler  â”‚      â”‚ - Validate       â”‚           â”‚ â”‚
â”‚  â”‚  â”‚   location       â”‚      â”‚   transition     â”‚           â”‚ â”‚
â”‚  â”‚  â”‚ - Check auto     â”‚      â”‚ - Apply          â”‚           â”‚ â”‚
â”‚  â”‚  â”‚   transitions    â”‚      â”‚   transition     â”‚           â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚         checkAutoTransitions()                      â”‚   â”‚ â”‚
â”‚  â”‚  â”‚                                                      â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  - T1: HAULING_EMPTY â†’ QUEUING                      â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  - T2: HAULING_LOAD â†’ DUMPING                       â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚                                â”‚                                  â”‚
â”‚                                â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Update Firestore Collections                   â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â€¢ hauler_events (new event)                               â”‚ â”‚
â”‚  â”‚  â€¢ haulers (status update)                                 â”‚ â”‚
â”‚  â”‚  â€¢ cycles (step update)                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â”‚ Real-time Stream
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLIENT RECEIVES UPDATE                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                  â”‚
â”‚  â”‚ Firestore    â”‚                                                  â”‚
â”‚  â”‚ Stream       â”‚                                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                  â”‚
â”‚         â”‚                                                          â”‚
â”‚         â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                  â”‚
â”‚  â”‚ HaulerBloc   â”‚                                                  â”‚
â”‚  â”‚              â”‚                                                  â”‚
â”‚  â”‚ - Compare    â”‚                                                  â”‚
â”‚  â”‚   local vs    â”‚                                                  â”‚
â”‚  â”‚   server      â”‚                                                  â”‚
â”‚  â”‚ - Detect      â”‚                                                  â”‚
â”‚  â”‚   correction  â”‚                                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                  â”‚
â”‚         â”‚                                                          â”‚
â”‚         â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                  â”‚
â”‚  â”‚ Update UI    â”‚                                                  â”‚
â”‚  â”‚              â”‚                                                  â”‚
â”‚  â”‚ - Status     â”‚                                                  â”‚
â”‚  â”‚ - Map        â”‚                                                  â”‚
â”‚  â”‚ - Event Log  â”‚                                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Alur Data Telemetry

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TELEMETRY DATA FLOW                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[GPS Sensor] â”€â”€â–¶ Location Update (every 1 second)
     â”‚
     â–¼
[LocationRepository]
     â”‚
     â–¼
[HaulerBloc.onUpdateLocation]
     â”‚
     â”œâ”€â”€â”€â–¶ Update Local State
     â”‚
     â”œâ”€â”€â”€â–¶ Process Auto Transitions
     â”‚
     â””â”€â”€â”€â–¶ Save Telemetry
              â”‚
              â”œâ”€â”€â”€ ONLINE â”€â”€â–¶ [FirestoreDataSource.saveTelemetry]
              â”‚                    â”‚
              â”‚                    â–¼
              â”‚              [Cloud Function: processTelemetry]
              â”‚                    â”‚
              â”‚                    â”œâ”€â”€â”€â–¶ Update hauler location
              â”‚                    â”‚
              â”‚                    â””â”€â”€â”€â–¶ Check auto transitions
              â”‚
              â””â”€â”€â”€ OFFLINE â”€â”€â–¶ [OfflineQueue.enqueue]
                                   â”‚
                                   â–¼
                              [Hive Storage]
                                   â”‚
                                   â–¼
                              [Sync when online]
```

### Alur Data Event

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        EVENT DATA FLOW                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[Status Transition Triggered]
     â”‚
     â–¼
[HaulerBloc._updateHaulerStatus]
     â”‚
     â”œâ”€â”€â”€â–¶ Create HaulerEventEntity
     â”‚         â”‚
     â”‚         â”œâ”€â”€â”€ Generate UUID
     â”‚         â”œâ”€â”€â”€ Increment seq
     â”‚         â”œâ”€â”€â”€ Create dedupKey
     â”‚         â””â”€â”€â”€ Set deviceTime
     â”‚
     â”œâ”€â”€â”€â–¶ Update Local Hauler State
     â”‚
     â””â”€â”€â”€â–¶ Save Event
              â”‚
              â”œâ”€â”€â”€ ONLINE â”€â”€â–¶ [FirestoreDataSource.saveEvent]
              â”‚                    â”‚
              â”‚                    â–¼
              â”‚              [Firestore: hauler_events/{dedupKey}]
              â”‚                    â”‚
              â”‚                    â””â”€â”€â”€â–¶ Server validates & processes
              â”‚
              â””â”€â”€â”€ OFFLINE â”€â”€â–¶ [OfflineQueue.enqueue]
                                   â”‚
                                   â–¼
                              [Hive: QueueItemData]
                                   â”‚
                                   â–¼
                              [Sync when online]
                                   â”‚
                                   â–¼
                              [Firestore: hauler_events/{dedupKey}]
                                   â”‚
                                   â””â”€â”€â”€â–¶ Idempotent write (dedupKey as doc ID)
```

---

## Proses Data: Sensor hingga Server

Bagian ini menjelaskan proses lengkap dari data didapatkan dari sensor/hardware hingga disimpan di server Firestore. Untuk flowchart detail, lihat [DIAGRAM_FLOWCHART.md](./DIAGRAM_FLOWCHART.md) bagian 9-13.

### Overview Proses

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          PROSES DATA: SENSOR â†’ SERVER                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. DATA ACQUISITION (Sensor/Hardware)
   â†“
2. DATA VALIDATION
   â†“
3. ENTITY CREATION (Domain Layer)
   â†“
4. BUSINESS LOGIC (BLoC Processing)
   â†“
5. REPOSITORY LAYER (Entity â†’ Model)
   â†“
6. CONNECTIVITY CHECK
   â†“
7. STORAGE (Online: Firestore | Offline: Hive Queue)
   â†“
8. SERVER PROCESSING (Cloud Functions)
```

### 1. Proses Location Data (GPS â†’ Server)

**Sumber Data**: GPS Sensor (Hardware)

**Alur Proses**:
1. **GPS Sensor** â†’ Mendapatkan posisi (lat, lng, accuracy)
2. **LocationService** â†’ Request position dari geolocator
3. **Validasi** â†’ Cek koordinat valid & accuracy â‰¤ 50m
4. **Entity Creation** â†’ Buat GeoLocation Entity
5. **HaulerBloc** â†’ Update local state, trigger auto transitions
6. **Repository** â†’ Convert entity ke model
7. **Connectivity Check** â†’ Online atau Offline?
   - **Online**: Langsung save ke Firestore
   - **Offline**: Queue ke Hive
8. **Firestore Write** â†’ Update hauler document
9. **UI Update** â†’ Update map, status panel

**Detail Flowchart**: Lihat [DIAGRAM_FLOWCHART.md](./DIAGRAM_FLOWCHART.md) bagian 9

### 2. Proses Event Data (Status Transition â†’ Server)

**Sumber Data**: Status transition (Auto/Manual/System)

**Alur Proses**:
1. **Trigger** â†’ Status transition terdeteksi
2. **HaulerBloc** â†’ Generate event data (UUID, seq, dedupKey)
3. **Entity Creation** â†’ Buat HaulerEvent Entity
4. **Local State Update** â†’ Update hauler status, cycle steps
5. **Repository** â†’ Convert entity ke model
6. **Connectivity Check** â†’ Online atau Offline?
   - **Online**: Langsung save ke Firestore dengan dedupKey sebagai doc ID
   - **Offline**: Queue ke Hive
7. **Firestore Write** â†’ Write ke collection `hauler_events` dengan idempotent write
8. **UI Update** â†’ Update status panel, event log

**Detail Flowchart**: Lihat [DIAGRAM_FLOWCHART.md](./DIAGRAM_FLOWCHART.md) bagian 10

### 3. Proses Telemetry Data (GPS + Sensor â†’ Server)

**Sumber Data**: GPS Location + Body Sensor

**Alur Proses**:
1. **Data Collection** â†’ Kumpulkan GPS + sensor data
2. **Entity Creation** â†’ Buat Telemetry Entity
3. **Repository** â†’ Convert entity ke model
4. **Connectivity Check** â†’ Online atau Offline?
   - **Online**: Langsung save ke Firestore
   - **Offline**: Queue ke Hive
5. **Firestore Write** â†’ Write ke collection `telemetry`
6. **Cloud Function Trigger** â†’ `processTelemetry` dipanggil
7. **Server Processing** â†’ Update hauler location, check auto transitions

**Detail Flowchart**: Lihat [DIAGRAM_FLOWCHART.md](./DIAGRAM_FLOWCHART.md) bagian 11

### 4. Proses Cycle Data (User Action â†’ Server)

**Sumber Data**: User input (Start Cycle, Complete Cycle)

**Alur Proses**:
1. **User Action** â†’ User klik start/complete cycle
2. **Validation** â†’ Validasi prerequisites (loader, dump point)
3. **Entity Creation** â†’ Buat/Update Cycle Entity
4. **Repository** â†’ Convert entity ke model
5. **Connectivity Check** â†’ Online atau Offline?
   - **Online**: Langsung save ke Firestore
   - **Offline**: Queue ke Hive
6. **Firestore Write** â†’ Write ke collection `cycles`
7. **UI Update** â†’ Update status panel, cycle info

**Detail Flowchart**: Lihat [DIAGRAM_FLOWCHART.md](./DIAGRAM_FLOWCHART.md) bagian 12

### 5. Proses Offline Queue Sync

Ketika data di-queue saat offline, proses sinkronisasi terjadi saat koneksi kembali:

1. **Connectivity Detected** â†’ Ping monitoring mendeteksi online
2. **Sync Strategy** â†’ Tentukan strategi berdasarkan ping quality
3. **Get Pending Items** â†’ Ambil items dari Hive queue
4. **Process Queue** â†’ Untuk setiap item:
   - Cek retry count
   - Try sync ke Firestore
   - Jika success: Remove dari queue
   - Jika fail: Increment retry count
5. **Idempotent Write** â†’ Gunakan dedupKey untuk mencegah duplikasi

### 6. Layer-by-Layer Data Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          LAYER-BY-LAYER DATA FLOW                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LAYER 1: DATA ACQUISITION
  â€¢ GPS Sensor â†’ LocationService
  â€¢ Body Sensor â†’ State update
  â€¢ User Input â†’ UI event

LAYER 2: DATA VALIDATION
  â€¢ Validate GPS coordinates
  â€¢ Check GPS accuracy â‰¤ 50m
  â€¢ Validate prerequisites

LAYER 3: ENTITY CREATION (Domain Layer)
  â€¢ GeoLocation Entity
  â€¢ HaulerEvent Entity
  â€¢ Cycle Entity
  â€¢ Telemetry Entity

LAYER 4: BUSINESS LOGIC (Presentation Layer)
  â€¢ HaulerBloc processing
  â€¢ State machine validation
  â€¢ Guard condition checks
  â€¢ Auto transition triggers

LAYER 5: REPOSITORY LAYER (Data Layer)
  â€¢ Entity â†’ Model conversion
  â€¢ Data transformation
  â€¢ Error handling

LAYER 6: CONNECTIVITY CHECK
  â€¢ Ping measurement
  â€¢ Network status
  â€¢ Sync strategy determination

LAYER 7: STORAGE
  â€¢ Online: Firestore Data Source
  â€¢ Offline: Hive Queue Data Source

LAYER 8: SERVER PROCESSING
  â€¢ Cloud Functions triggers
  â€¢ Data validation
  â€¢ Auto transitions
  â€¢ State updates
```

### Key Points

1. **Idempotency**: Semua writes menggunakan dedupKey untuk mencegah duplikasi
2. **Optimistic Updates**: UI selalu update optimistically, kemudian reconcile dengan server
3. **Offline Support**: Semua data di-queue saat offline, sync saat online
4. **Error Handling**: Retry mechanism dengan max retry limit
5. **Real-time Sync**: Firestore streams untuk real-time updates

---

## Metode Sinkronisasi

### Strategi Sinkronisasi Berbasis Ping

Sistem menggunakan **ping-based sync strategy** yang menyesuaikan strategi sinkronisasi berdasarkan kualitas koneksi jaringan.

#### Connection Quality Levels

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CONNECTION QUALITY & SYNC STRATEGY                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ping Time          Quality          Sync Strategy        Description
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
< 50ms             Excellent        Immediate            Sync langsung tanpa delay
50-150ms           Good             Batched              Batch sync setiap 2 detik
150-300ms          Fair             Delayed              Batch sync setiap 5 detik
300-500ms          Poor             Critical Only        Hanya sync event & hauler update
> 500ms / Timeout  Offline          Queue                Queue semua, sync saat online
```

#### Flowchart Sinkronisasi

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              FLOWCHART METODE SINKRONISASI                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

START
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ping Monitoring â”‚ (Every 5 seconds)
â”‚ Started         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Measure Ping    â”‚
â”‚ to Firestore    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Determine Quality      â”‚
â”‚ & Sync Strategy        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€ Excellent (<50ms) â”€â”€â–¶ [IMMEDIATE]
         â”‚                              â”‚
         â”‚                              â–¼
         â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                    â”‚ Cancel batch    â”‚
         â”‚                    â”‚ timer, sync   â”‚
         â”‚                    â”‚ immediately   â”‚
         â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚                             â”‚
         â”œâ”€â”€â”€ Good (50-150ms) â”€â”€â–¶ [BATCHED]
         â”‚                             â”‚
         â”‚                             â–¼
         â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                    â”‚ Setup batch     â”‚
         â”‚                    â”‚ timer (2s)      â”‚
         â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                             â”‚
         â”œâ”€â”€â”€ Fair (150-300ms) â”€â”€â–¶ [DELAYED]
         â”‚                             â”‚
         â”‚                             â–¼
         â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                    â”‚ Setup batch     â”‚
         â”‚                    â”‚ timer (5s)      â”‚
         â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                             â”‚
         â”œâ”€â”€â”€ Poor (300-500ms) â”€â”€â–¶ [CRITICAL_ONLY]
         â”‚                             â”‚
         â”‚                             â–¼
         â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                    â”‚ Sync only       â”‚
         â”‚                    â”‚ critical items  â”‚
         â”‚                    â”‚ (events, updates)â”‚
         â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                             â”‚
         â””â”€â”€â”€ Offline (>500ms) â”€â”€â–¶ [QUEUE]
                                      â”‚
                                      â–¼
                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚ Queue all items â”‚
                             â”‚ to Hive         â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚ Wait for        â”‚
                             â”‚ connectivity    â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                             [When Online]
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Process Offline Queue                   â”‚
â”‚                                         â”‚
â”‚ FOR each item in queue:                 â”‚
â”‚   â”œâ”€â”€â”€ Check retry count                â”‚
â”‚   â”œâ”€â”€â”€ IF retry > max: Remove           â”‚
â”‚   â”œâ”€â”€â”€ ELSE:                            â”‚
â”‚   â”‚   â”œâ”€â”€â”€ Try sync to Firestore        â”‚
â”‚   â”‚   â”œâ”€â”€â”€ IF success: Remove           â”‚
â”‚   â”‚   â””â”€â”€â”€ IF fail: Increment retry    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
END
```

### Offline Queue Mechanism

#### Queue Item Types

1. **Event** (`QueueItemType.event`)
   - Status transition events
   - Priority: HIGH
   - Retry: Yes

2. **Telemetry** (`QueueItemType.telemetry`)
   - GPS location data
   - Priority: MEDIUM
   - Retry: Yes (with rate limiting)

3. **Hauler Update** (`QueueItemType.haulerUpdate`)
   - Status updates
   - Priority: HIGH
   - Retry: Yes

4. **Intent** (`QueueItemType.intent`)
   - Client requests to server
   - Priority: HIGH
   - Retry: Yes

#### Queue Processing Logic

```dart
// Pseudocode
Future<void> _processOfflineQueue() async {
  final items = await offlineQueue.getPendingItems();
  
  for (final item in items) {
    // Skip if exceeded max retries
    if (!item.shouldRetry) {
      await offlineQueue.remove(item.queueKey);
      continue;
    }

    try {
      await _syncItem(item);
      await offlineQueue.remove(item.queueKey);
    } catch (e) {
      await offlineQueue.incrementRetry(item.queueKey);
    }
  }
}
```

### Idempotency & Deduplication

#### DedupKey Format

```
dedupKey = "${haulerId}_${cycleId}_${seq}_${cause.code}"
```

**Contoh:**
```
HLR-abc123_cycle-xyz789_5_ENTERED_LOADER_RADIUS
```

#### Idempotent Write Strategy

1. **Document ID = dedupKey**: Menggunakan dedupKey sebagai document ID di Firestore
2. **Merge Strategy**: Menggunakan `SetOptions(merge: true)` untuk menghindari overwrite
3. **Sequence Number**: Monotonic sequence per cycle untuk ordering
4. **Server Validation**: Server memvalidasi seq untuk mencegah out-of-order events

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              IDEMPOTENCY MECHANISM                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client creates event:
  dedupKey = "HLR-123_cycle-456_5_T1"
  
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Try write to    â”‚
  â”‚ Firestore       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â”€â”€ Success â”€â”€â–¶ [Done]
           â”‚
           â””â”€â”€â”€ Fail (offline) â”€â”€â–¶ [Queue to Hive]
                                      â”‚
                                      â–¼
                              [When online, retry]
                                      â”‚
                                      â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ Firestore write â”‚
                              â”‚ with dedupKey   â”‚
                              â”‚ as doc ID       â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â”œâ”€â”€â”€ Document exists â”€â”€â–¶ [Merge/Update]
                                       â”‚
                                       â””â”€â”€â”€ Document new â”€â”€â–¶ [Create]
```

---

## Olah Data & Event Sourcing

### Event Sourcing Architecture

Sistem menggunakan **Event Sourcing** untuk mencatat semua perubahan status sebagai immutable events.

#### Event Structure

```dart
HaulerEventEntity {
  id: String                    // UUID
  haulerId: String             // "HLR-xxxx"
  cycleId: String              // "cycle-uuid"
  fromStatus: HaulerStatus?    // Status sebelumnya
  toStatus: HaulerStatus?      // Status baru
  cause: TransitionCause       // Penyebab transisi
  deviceTime: DateTime         // Waktu di device
  serverTime: DateTime?        // Waktu di server (setelah sync)
  seq: int                     // Sequence number (monotonic)
  dedupKey: String             // Idempotency key
  metadata: Map?               // Data tambahan (location, etc.)
  synced: bool                 // Status sinkronisasi
}
```

#### Event Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EVENT LIFECYCLE                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. EVENT CREATION
   â”‚
   â”œâ”€â”€â”€ Trigger: Status transition
   â”œâ”€â”€â”€ Generate: UUID, seq, dedupKey
   â”œâ”€â”€â”€ Set: deviceTime, metadata
   â””â”€â”€â”€ State: synced = false
   
2. LOCAL PERSISTENCE
   â”‚
   â”œâ”€â”€â”€ Update: Local hauler state
   â”œâ”€â”€â”€ Add: Event to cycle steps
   â””â”€â”€â”€ Queue: If offline
   
3. SYNC TO SERVER
   â”‚
   â”œâ”€â”€â”€ Write: Firestore hauler_events/{dedupKey}
   â”œâ”€â”€â”€ Set: serverTime (server timestamp)
   â””â”€â”€â”€ Update: synced = true
   
4. SERVER PROCESSING
   â”‚
   â”œâ”€â”€â”€ Validate: Transition rules
   â”œâ”€â”€â”€ Check: Guard conditions
   â”œâ”€â”€â”€ Apply: Status update
   â””â”€â”€â”€ Log: Event to hauler_events
   
5. CLIENT RECONCILIATION
   â”‚
   â”œâ”€â”€â”€ Stream: hauler_events updates
   â”œâ”€â”€â”€ Compare: Local vs server state
   â”œâ”€â”€â”€ Detect: Server corrections
   â””â”€â”€â”€ Update: UI if needed
```

### Data Processing Pipeline

#### 1. Location Processing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LOCATION DATA PROCESSING                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[GPS Update] (every 1 second)
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Validate GPS    â”‚
â”‚ Accuracy        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€ accuracy > 50m â”€â”€â–¶ [REJECT] â”€â”€â–¶ Skip transition checks
         â”‚
         â–¼ accuracy â‰¤ 50m
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Calculate       â”‚
â”‚ Distance        â”‚
â”‚                 â”‚
â”‚ - To loader     â”‚
â”‚ - To dump point â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check Auto      â”‚
â”‚ Transitions     â”‚
â”‚                 â”‚
â”‚ T1: QUEUING â†’   â”‚
â”‚     SPOTTING    â”‚
â”‚                 â”‚
â”‚ T2: HAULING_LOADâ”‚
â”‚     â†’ DUMPING   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Save Telemetry  â”‚
â”‚ to Firestore    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2. Event Processing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EVENT PROCESSING                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[Event Created]
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Validate Event  â”‚
â”‚                 â”‚
â”‚ - Check seq     â”‚
â”‚ - Check dedupKeyâ”‚
â”‚ - Validate      â”‚
â”‚   transition    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€ Invalid â”€â”€â–¶ [REJECT] â”€â”€â–¶ Log error
         â”‚
         â–¼ Valid
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Update State    â”‚
â”‚                 â”‚
â”‚ - Hauler status â”‚
â”‚ - Cycle steps   â”‚
â”‚ - Event seq     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Persist Event   â”‚
â”‚                 â”‚
â”‚ - Local state   â”‚
â”‚ - Firestore     â”‚
â”‚ - Offline queue â”‚
â”‚   (if offline)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Trigger Side    â”‚
â”‚ Effects         â”‚
â”‚                 â”‚
â”‚ - Update UI     â”‚
â”‚ - Log event     â”‚
â”‚ - Notify        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3. Cycle Processing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CYCLE PROCESSING                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[Cycle Started]
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create Cycle    â”‚
â”‚ Entity          â”‚
â”‚                 â”‚
â”‚ - Generate ID   â”‚
â”‚ - Set loader    â”‚
â”‚ - Set dump pointâ”‚
â”‚ - Initialize    â”‚
â”‚   steps         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Save to         â”‚
â”‚ Firestore       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
[Status Updates]
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Add Cycle Step  â”‚
â”‚                 â”‚
â”‚ - Status        â”‚
â”‚ - Timestamp     â”‚
â”‚ - Location      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Update Cycle    â”‚
â”‚ in Firestore    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
[Cycle Complete]
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mark Complete   â”‚
â”‚                 â”‚
â”‚ - Set completed â”‚
â”‚ - Set end time  â”‚
â”‚ - Calculate     â”‚
â”‚   duration      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Final Update    â”‚
â”‚ to Firestore    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Server-Side Data Processing

#### Cloud Function: processTelemetry

```typescript
// Pseudocode
processTelemetry(telemetry) {
  1. Update hauler location in Firestore
  2. Check auto transitions:
     - T1: HAULING_EMPTY â†’ QUEUING (if in loader radius)
     - T2: HAULING_LOAD â†’ DUMPING (if in dump radius + bodyUp)
  3. If transition triggered:
     - Create event
     - Update hauler status
     - Log to hauler_events
}
```

#### Cloud Function: processIntent

```typescript
// Pseudocode
processIntent(intent) {
  1. Get hauler, cycle, loader data
  2. Validate transition:
     - Check allowed transitions
     - Check guard conditions
     - Check GPS accuracy
  3. If valid:
     - Create event
     - Update hauler status
     - Mark intent as processed
  4. If invalid:
     - Mark intent as failed
     - Log reason
}
```

---

## Struktur Data Firestore

### Collections Overview

```
firestore/
â”œâ”€â”€ haulers/                    # Hauler documents
â”‚   â””â”€â”€ {haulerId}/
â”‚       â”œâ”€â”€ id: string
â”‚       â”œâ”€â”€ currentStatus: string
â”‚       â”œâ”€â”€ lastStatusChangeAt: timestamp
â”‚       â”œâ”€â”€ location: { lat, lng, accuracy }
â”‚       â”œâ”€â”€ bodyUp: boolean
â”‚       â”œâ”€â”€ online: boolean
â”‚       â”œâ”€â”€ deviceTime: timestamp
â”‚       â”œâ”€â”€ cycleId: string?
â”‚       â”œâ”€â”€ assignedLoaderId: string?
â”‚       â””â”€â”€ eventSeq: number
â”‚
â”œâ”€â”€ hauler_events/              # Event sourcing log
â”‚   â””â”€â”€ {dedupKey}/
â”‚       â”œâ”€â”€ haulerId: string
â”‚       â”œâ”€â”€ cycleId: string
â”‚       â”œâ”€â”€ fromStatus: string?
â”‚       â”œâ”€â”€ toStatus: string?
â”‚       â”œâ”€â”€ cause: string
â”‚       â”œâ”€â”€ deviceTime: timestamp
â”‚       â”œâ”€â”€ serverTime: timestamp
â”‚       â”œâ”€â”€ seq: number
â”‚       â”œâ”€â”€ dedupKey: string
â”‚       â”œâ”€â”€ metadata: object?
â”‚       â””â”€â”€ synced: boolean
â”‚
â”œâ”€â”€ telemetry/                  # Location & sensor data
â”‚   â””â”€â”€ {telemetryId}/
â”‚       â”œâ”€â”€ haulerId: string
â”‚       â”œâ”€â”€ cycleId: string
â”‚       â”œâ”€â”€ lat: number
â”‚       â”œâ”€â”€ lng: number
â”‚       â”œâ”€â”€ accuracy: number?
â”‚       â”œâ”€â”€ bodyUp: boolean
â”‚       â”œâ”€â”€ deviceTime: timestamp
â”‚       â””â”€â”€ createdAt: timestamp
â”‚
â”œâ”€â”€ cycles/                     # Cycle tracking
â”‚   â””â”€â”€ {cycleId}/
â”‚       â”œâ”€â”€ id: string
â”‚       â”œâ”€â”€ haulerId: string
â”‚       â”œâ”€â”€ loaderId: string?
â”‚       â”œâ”€â”€ loaderLocation: { lat, lng }
â”‚       â”œâ”€â”€ dumpLocation: { lat, lng }
â”‚       â”œâ”€â”€ dumpRadius: number
â”‚       â”œâ”€â”€ steps: CycleStep[]
â”‚       â”œâ”€â”€ completed: boolean
â”‚       â”œâ”€â”€ anomalies: string[]
â”‚       â”œâ”€â”€ startedAt: timestamp
â”‚       â””â”€â”€ completedAt: timestamp?
â”‚
â”œâ”€â”€ loaders/                    # Loader equipment
â”‚   â””â”€â”€ {loaderId}/
â”‚       â”œâ”€â”€ id: string
â”‚       â”œâ”€â”€ name: string
â”‚       â”œâ”€â”€ location: { lat, lng }
â”‚       â”œâ”€â”€ waitingTruck: boolean
â”‚       â””â”€â”€ radius: number
â”‚
â””â”€â”€ intents/                    # Client intents
    â””â”€â”€ {intentId}/
        â”œâ”€â”€ haulerId: string
        â”œâ”€â”€ cycleId: string
        â”œâ”€â”€ type: string
        â”œâ”€â”€ requestedStatus: string?
        â”œâ”€â”€ deviceTime: timestamp
        â”œâ”€â”€ location: { lat, lng }?
        â”œâ”€â”€ context: object?
        â”œâ”€â”€ processed: boolean
        â”œâ”€â”€ success: boolean?
        â”œâ”€â”€ errorMessage: string?
        â””â”€â”€ resultEventId: string?
```

### Data Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATA RELATIONSHIPS                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

hauler (1) â”€â”€â”
             â”‚
             â”œâ”€â”€â”€â–¶ (many) hauler_events
             â”‚
             â”œâ”€â”€â”€â–¶ (many) telemetry
             â”‚
             â””â”€â”€â”€â–¶ (many) cycles
                      â”‚
                      â””â”€â”€â”€â–¶ (1) loader
```

---

## Proses Bisnis Detail

### Skenario 1: Siklus Normal (Online)

```
1. User memulai cycle
   â”œâ”€â”€â”€ Create cycle document
   â”œâ”€â”€â”€ Transition: STANDBY â†’ QUEUING
   â””â”€â”€â”€ Save event to Firestore

2. Hauler bergerak ke loader
   â”œâ”€â”€â”€ GPS update setiap 1 detik
   â”œâ”€â”€â”€ Telemetry saved ke Firestore
   â””â”€â”€â”€ Server check: T1 condition

3. Masuk radius loader
   â”œâ”€â”€â”€ Auto transition: QUEUING â†’ SPOTTING
   â”œâ”€â”€â”€ Event created & synced
   â””â”€â”€â”€ UI update real-time

4. Loader confirmed
   â”œâ”€â”€â”€ Transition: SPOTTING â†’ LOADING
   â””â”€â”€â”€ Event logged

5. Loading complete
   â”œâ”€â”€â”€ Manual transition: LOADING â†’ HAULING_LOAD
   â””â”€â”€â”€ Cycle step added

6. Hauler bergerak ke dump point
   â”œâ”€â”€â”€ GPS tracking
   â”œâ”€â”€â”€ Telemetry streaming
   â””â”€â”€â”€ Server monitoring: T2 condition

7. Masuk radius dump + body up
   â”œâ”€â”€â”€ Auto transition: HAULING_LOAD â†’ DUMPING
   â””â”€â”€â”€ Event created

8. Body down
   â”œâ”€â”€â”€ Auto transition: DUMPING â†’ HAULING_EMPTY
   â””â”€â”€â”€ Event logged

9. Kembali ke loader
   â”œâ”€â”€â”€ Auto transition: HAULING_EMPTY â†’ QUEUING
   â””â”€â”€â”€ Cycle continues
```

### Skenario 2: Siklus Offline

```
1. Cycle started (online)
   â”œâ”€â”€â”€ Cycle created in Firestore
   â””â”€â”€â”€ Status: QUEUING

2. Connection lost
   â”œâ”€â”€â”€ Offline queue activated
   â””â”€â”€â”€ Local state machine continues

3. Transitions terjadi offline
   â”œâ”€â”€â”€ Events queued to Hive
   â”œâ”€â”€â”€ Local state updated
   â””â”€â”€â”€ UI shows optimistic updates

4. Connection restored
   â”œâ”€â”€â”€ Ping monitoring detects online
   â”œâ”€â”€â”€ Sync strategy determined
   â””â”€â”€â”€ Queue processed

5. Events synced
   â”œâ”€â”€â”€ Idempotent writes (dedupKey)
   â”œâ”€â”€â”€ Server validates
   â””â”€â”€â”€ State reconciled
```

### Skenario 3: Server Correction

```
1. Client: Local transition QUEUING â†’ SPOTTING
   â”œâ”€â”€â”€ Event queued (offline)
   â””â”€â”€â”€ Local state updated

2. Connection restored
   â”œâ”€â”€â”€ Event synced to server
   â””â”€â”€â”€ Server validates

3. Server rejects (invalid condition)
   â”œâ”€â”€â”€ Server creates correction event
   â”œâ”€â”€â”€ Updates hauler status
   â””â”€â”€â”€ Streams update to client

4. Client receives correction
   â”œâ”€â”€â”€ Compares local vs server
   â”œâ”€â”€â”€ Detects mismatch
   â”œâ”€â”€â”€ Updates local state
   â””â”€â”€â”€ Shows correction banner
```

---

## Teknologi & Dependencies

### Client (Flutter)

- **State Management**: flutter_bloc
- **Local Storage**: Hive
- **Remote Storage**: Cloud Firestore
- **Maps**: flutter_map + OpenStreetMap
- **Location**: geolocator
- **Connectivity**: connectivity_plus
- **Dependency Injection**: get_it

### Server (Cloud Functions)

- **Runtime**: Node.js
- **Framework**: Firebase Functions
- **Database**: Cloud Firestore
- **Language**: TypeScript

---

## Kesimpulan

Sistem **Hauler Truck** menggunakan arsitektur **offline-first** dengan **event-sourcing** untuk memastikan:

1. âœ… **Reliability**: Operasi tetap berjalan saat offline
2. âœ… **Consistency**: Server sebagai single source of truth
3. âœ… **Traceability**: Semua perubahan tercatat sebagai events
4. âœ… **Performance**: Ping-based sync strategy untuk optimasi
5. âœ… **Idempotency**: DedupKey mechanism mencegah duplikasi

Sistem ini dirancang untuk operasi tambang yang memerlukan ketahanan terhadap kondisi jaringan yang tidak stabil, sambil tetap menjaga konsistensi data dan kemampuan audit yang lengkap.

